<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body { font-family: sans-serif; background-color: #121212; color: white; }
    #chatBox { height: 400px; overflow-y: auto; border: 1px solid #444; padding: 10px; margin-bottom: 10px; }
    #chatBox li { margin: 4px 0; color: #ddd; }
    strong { font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ’¬ Chat en tiempo real</h1>


  <div id="colorPickerContainer">
    <label for="colorPicker">Elige tu color de nombre:</label>
    <input type="color" id="colorPicker" value="#1E90FF" />
    <button id="joinChat">Entrar al chat</button>
  </div>


  <div id="chatContainer" style="display:none;">
    <ul id="chatBox"></ul>
    <form id="chatForm">
      <input id="chatInput" type="text" placeholder="Escribe tu mensaje..." autocomplete="off" />
      <button type="submit">Enviar</button>
    </form>
  </div>

  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function () {
      
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
     
      if (!token || !user) {
        alert('Debes iniciar sesiÃ³n para acceder al chat');
        location.href = '/login.html'; 
        return; 

      function validarHex(c) {
        return /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c); 
      }

      
      let chosenColor = localStorage.getItem('chatColor') || '';

      
      if (!chosenColor || !validarHex(chosenColor)) {
        const input = prompt("Por favor, ingresa tu color en formato HEX (p. ej. #FF6347):");

      
        chosenColor = validarHex(input || '') ? input : '#1E90FF'; 
        localStorage.setItem('chatColor', chosenColor); 
      }

      
      localStorage.setItem('chatColor', chosenColor);

    
      const colorPicker = document.getElementById('colorPicker');
      colorPicker.value = chosenColor; 

      colorPicker.addEventListener('input', (e) => {
        chosenColor = e.target.value; 
        localStorage.setItem('chatColor', chosenColor); 
      });

      
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          location.href = '/login.html'; 
        });
      }

      
      const socket = io('/', { auth: { token, color: chosenColor } });

      const chatBox = document.getElementById('chatBox');
      const chatForm = document.getElementById('chatForm');
      const chatInput = document.getElementById('chatInput');

      if (!chatInput) {
        console.error("El campo de texto para enviar el mensaje no se ha encontrado");
        return; 
      }

      
      function appendSystem(text) {
        const el = document.createElement('div');
        el.style.opacity = 0.75;
        el.textContent = `â€¢ ${text}`;
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

     
      function appendMessage({ user, text, ts, color }) {
        const row = document.createElement('div');
        const time = new Date(ts).toLocaleTimeString();
        const nameColor = color || '#fff';
        row.innerHTML = `<strong style="color:${nameColor}">${user}</strong> <small>${time}</small><br>${text}`;
        chatBox.appendChild(row);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      
      socket.on('connect_error', (err) => {
        appendSystem('Error de conexiÃ³n: ' + (err?.message || 'desconocido'));
      });

      socket.on('chat:system', appendSystem);

       
      socket.on('chat:message', (msg) => {
        
        appendMessage(msg);
      });

  
      const joinChatBtn = document.getElementById('joinChat');
      const colorPickerContainer = document.getElementById('colorPickerContainer');
      const chatContainer = document.getElementById('chatContainer');

      joinChatBtn.addEventListener('click', () => {
       
        colorPickerContainer.style.display = 'none';
        chatContainer.style.display = 'block';
        socket.emit('chat:join', { username: user.username, color: chosenColor });
      });

      
      chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        socket.emit('chat:message', text); 
        chatInput.value = ''; 
      });
    })(); 
  </script>
</body>
</html>



